<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Monitor Class</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .last-update {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            backdrop-filter: blur(10px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .performance-chart {
            position: relative;
            height: 300px;
        }

        .emotion-indicator {
            text-align: center;
            padding: 20px;
        }

        .emotion-score {
            font-size: 3rem;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
        }

        .emotion-label {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        /* Camera feed styles */
        .camera-feed {
            position: relative;
            height: 300px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .camera-placeholder {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1rem;
        }

        .camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-indicator.active {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .camera-controls {
            margin-top: 15px;
            text-align: center;
        }

        .camera-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .camera-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* Report Generation Section */
        .report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .report-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .report-section h2 i {
            color: #667eea;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1rem;
        }

        .form-group label i {
            margin-right: 8px;
            color: #667eea;
        }

        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .checkbox-wrapper:hover {
            border-color: #667eea;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn.btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn.btn-success:hover {
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }

        .main-report {
            background: linear-gradient(135deg, #17ef79 0%, #0984e3 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .main-report h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .report-content {
            line-height: 1.8;
            font-size: 1.1rem;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .students-table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .students-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: none;
        }

        .students-table th:first-child {
            border-radius: 10px 0 0 0;
        }

        .students-table th:last-child {
            border-radius: 0 10px 0 0;
        }

        .students-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            transition: background-color 0.3s ease;
        }

        .students-table tr:hover td {
            background-color: #f8f9fa;
        }

        .emotion-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .emotion-score-small {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .emotion-duration {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .student-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .angry { color: #f39c12; }
        .disgust { color: #3498db; }
        .fear { color: #e74c3c; }
        .happy { color: #e67e22; }
        .sad { color: #95a5a6; }
        .surprise { color: #27ae60; }
        .neutral { color: #8e44ad; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .students-table-container {
                padding: 15px;
            }

            .btn-group {
                flex-direction: column;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 40px 0;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-brain"></i> Smart Monitor Class</h1>
            <div class="last-update">
                <i class="fas fa-clock"></i> Cập nhật lần cuối: <span id="lastUpdate">{{ last_update or 'Chưa có dữ liệu' }}</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">Tổng số học sinh</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgHappiness">0%</div>
                <div class="stat-label">Độ vui vẻ trung bình</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgConfidence">0%</div>
                <div class="stat-label">Độ tự tin trung bình</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgFear">0%</div>
                <div class="stat-label">Độ lo lắng trung bình</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Phân Bố Hiệu Suất Học Tập
                </h3>
                <div class="performance-chart">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">
                    <i class="fas fa-smile"></i>
                    Chỉ Số Cảm Xúc Tích Cực
                </h3>
                <div class="emotion-indicator">
                    <div class="emotion-score" id="positiveScore">85%</div>
                    <div class="emotion-label">Tích cực chung của lớp</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">
                    <i class="fas fa-video"></i>
                    Camera Giám Sát
                </h3>
                <div class="camera-feed">
                    <img id="cameraStream" class="camera-video" src="{{ url_for('video_feed') }}" alt="Camera Feed">
                    <div id="cameraPlaceholder" class="camera-placeholder">
                        <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 10px;"></i>
                        <p>Đang kết nối camera...</p>
                    </div>
                    <div class="camera-status">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText">Offline</span>
                    </div>
                </div>
                <div class="camera-controls">
                    <button class="camera-btn" onclick="toggleCamera()" id="toggleBtn">
                        <i class="fas fa-play"></i> Bật Camera
                    </button>
                    <button class="camera-btn" onclick="captureImage()">
                        <i class="fas fa-camera"></i> Chụp Ảnh
                    </button>
                </div>
            </div>
        </div>

        <div class="section-divider"></div>

        <!-- Report Generation Section -->
        <div class="report-section">
            <h2>
                <i class="fas fa-file-alt"></i>
                Tạo Báo Cáo Lớp Học
            </h2>
            
            <form method="POST">
                <div class="form-group">
                    <label for="input_text">
                        <i class="fas fa-keyboard"></i>
                        Nhập dữ liệu báo cáo:
                    </label>
                    <textarea 
                        name="input_text" 
                        id="input_text" 
                        placeholder="Nhập thông tin về tình hình lớp học, điểm danh, kết quả học tập, hoạt động ngoại khóa..."
                    >{{ input_text }}</textarea>
                </div>

                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" name="use_ai" id="use_ai" {% if use_ai %}checked{% endif %}>
                        <label for="use_ai">
                            <i class="fas fa-robot"></i>
                            Sử dụng AI để tối ưu hóa báo cáo
                        </label>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn">
                        <i class="fas fa-magic"></i>
                        Tạo Báo Cáo
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateReport()">
                        <i class="fas fa-download"></i>
                        Xuất Báo Cáo
                    </button>
                </div>
            </form>

            <div class="main-report">
                <h3>
                    <i class="fas fa-file-alt"></i>
                    Báo Cáo Tình Hình Chung Của Lớp
                </h3>
                <div class="report-content" id="mainReport">
                    {% if report %}
                        <p>{{ report }}</p>
                    {% else %}
                        <div style="text-align: center; color: rgba(255,255,255,0.8);">
                            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Chưa có báo cáo. Vui lòng nhập dữ liệu và tạo báo cáo.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="students-table-container">
            <h3 class="card-title">
                <i class="fas fa-users"></i>
                Chi Tiết Cảm Xúc Từng Học Sinh
            </h3>
            <table class="students-table">
                <thead>
                    <tr>
                        <th>Tên Học Sinh</th>
                        <th><i class="fas fa-angry"></i> Tức Giận</th>
                        <th><i class="fas fa-disgust"></i> Ghê Tởm</th>
                        <th><i class="fas fa-fear"></i> Sợ Hãi</th>
                        <th><i class="fas fa-laugh"></i> Vui Vẻ</th>
                        <th><i class="fas fa-sad-tear"></i> Buồn Bã</th>
                        <th><i class="fas fa-surprise"></i> Ngạc Nhiên</th>
                        <th><i class="fas fa-meh"></i> Bình Thường</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- Dữ liệu sẽ được load bằng JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i> Làm mới
    </button>

    <script>
        let performanceChart;
        let studentsData = [];
        let cameraActive = false;

        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Tính toán hiệu suất học tập dựa trên cảm xúc tích cực
            const performanceData = calculatePerformanceDistribution();
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: performanceData.labels,
                    datasets: [{
                        label: 'Số lượng học sinh',
                        data: performanceData.counts,
                        backgroundColor: [
                            '#e74c3c',
                            '#f39c12', 
                            '#f1c40f',
                            '#2ecc71',
                            '#27ae60'
                        ],
                        borderColor: [
                            '#c0392b',
                            '#e67e22',
                            '#f39c12', 
                            '#27ae60',
                            '#229954'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Số lượng học sinh'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mức độ hiệu suất học tập'
                            }
                        }
                    }
                }
            });
        }

        function calculatePerformanceDistribution() {
            const labels = ['Rất thấp', 'Thấp', 'Trung bình', 'Cao', 'Rất cao'];
            const counts = [0, 0, 0, 0, 0];
            
            studentsData.forEach(student => {
                // Tính hiệu suất dựa trên cảm xúc tích cực (happy, surprise) - cảm xúc tiêu cực (angry, disgust, fear, sad)
                const positive = (student.emotions.happy?.score || 0) + 
                               (student.emotions.surprise?.score || 0);
                const negative = (student.emotions.angry?.score || 0) + 
                               (student.emotions.disgust?.score || 0) +
                               (student.emotions.fear?.score || 0) + 
                               (student.emotions.sad?.score || 0);
                
                const performance = (positive - negative) / 2; // Normalize
                
                if (performance < -0.5) counts[0]++;
                else if (performance < -0.1) counts[1]++;
                else if (performance < 0.3) counts[2]++;
                else if (performance < 0.7) counts[3]++;
                else counts[4]++;
            });
            
            return { labels, counts };
        }
        
            function fetchInputText() {
        fetch('/get_input_text')
            .then(response => response.json())
            .then(data => {
                // Cập nhật giá trị vào textarea mỗi khi có dữ liệu mới
                document.getElementById('input_text').value = data.input_text;
            })
            .catch(error => console.error('Error fetching input_text:', error));
    }

    // Tự động lấy dữ liệu mỗi 5 giây
    setInterval(fetchInputText, 5000);

    // Gọi ngay khi trang load
    window.onload = function() {
        fetchInputText();
    }

        function generateReport() {
            const inputText = document.getElementById('input_text').value;
            const useAI = document.getElementById('use_ai').checked;
            
            if (!inputText.trim()) {
                alert('Vui lòng nhập dữ liệu trước khi tạo báo cáo!');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xuất...';
            btn.disabled = true;

            // Gửi lệnh POST để xuất báo cáo
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `input_text=${encodeURIComponent(inputText)}&use_ai=${useAI ? 'on' : ''}`
            })
            .then(response => response.text())
            .then(data => {
                // Parse HTML response to extract report content
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');
                const reportElement = doc.querySelector('#mainReport');
                
                if (reportElement) {
                    document.getElementById('mainReport').innerHTML = reportElement.innerHTML;
                    alert('Báo cáo đã được tạo thành công!');
                } else {
                    alert('Có lỗi xảy ra khi tạo báo cáo!');
                }
            })
            .catch(error => {
                console.error('Error generating report:', error);
                alert('Có lỗi xảy ra khi tạo báo cáo!');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function calculatePositiveScore() {
            if (studentsData.length === 0) return 0;
            
            let totalPositive = 0;
            studentsData.forEach(student => {
                const positive = (student.emotions.happy?.score || 0) + 
                               (student.emotions.surprise?.score || 0);
                const negative = (student.emotions.angry?.score || 0) + 
                               (student.emotions.disgust?.score || 0) +
                               (student.emotions.fear?.score || 0) + 
                               (student.emotions.sad?.score || 0);
                
                totalPositive += Math.max(0, (positive - negative) / 2);
            });
            
            return Math.round((totalPositive / studentsData.length) * 100);
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = studentsData.length;
            
            if (studentsData.length > 0) {
                const avgHappiness = studentsData.reduce((sum, student) => 
                    sum + (student.emotions.happy?.score || 0), 0) / studentsData.length;
                const avgConfidence = studentsData.reduce((sum, student) => 
                    sum + (student.emotions.surprise?.score || 0), 0) / studentsData.length;
                const avgFear = studentsData.reduce((sum, student) => 
                    sum + (student.emotions.fear?.score || 0), 0) / studentsData.length;
                
                document.getElementById('avgHappiness').textContent = Math.round(avgHappiness * 100) + '%';
                document.getElementById('avgConfidence').textContent = Math.round(avgConfidence * 100) + '%';
                document.getElementById('avgFear').textContent = Math.round(avgFear * 100) + '%';
            }
            
            document.getElementById('positiveScore').textContent = calculatePositiveScore() + '%';
        }

        function renderStudentsTable() {
            const EMOTION_ORDER = [
                { key: "angry", class: "angry" },
                { key: "disgust", class: "disgust" },
                { key: "fear", class: "fear" },
                { key: "happy", class: "happy" },
                { key: "sad", class: "sad" },
                { key: "surprise", class: "surprise" },// Tự Tin
                { key: "neutral", class: "neutral" }         // Mệt Mỏi
            ];

            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';  // Clear the table

            studentsData.forEach(student => {
                const row = document.createElement('tr');
                
                // Cột tên học sinh
                let html = `<td class="student-name">${student.name}</td>`;

                // Loop qua tất cả các cảm xúc và tạo các cột tương ứng
                EMOTION_ORDER.forEach(emotionConfig => {
                    // Lấy dữ liệu cảm xúc cho học sinh
                    const emotionData = student.emotions[emotionConfig.key] || { score: 0, duration: 0 };
                    
                    const score = emotionData.score * 100;  // Chuyển đổi điểm thành phần trăm
                    const duration = emotionData.duration.toFixed(1);  // Thời gian tính bằng phút

                    // Tạo ID cho từng ô cảm xúc
                    const emotionId = `${student.name.replace(/\s+/g, '_')}_${emotionConfig.key}`;
                    
                    // Tạo từng ô cảm xúc cho mỗi học sinh
                    html += `<td class="emotion-cell" id="${emotionId}">
                                <span class="emotion-score-small ${emotionConfig.class}">${Math.round(score)}%</span>
                                <span class="emotion-duration">${duration}min</span>
                            </td>`;
                });

                // Gắn nội dung vào dòng
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        // Camera functions
        function toggleCamera() {
            const cameraStream = document.getElementById('cameraStream');
            const placeholder = document.getElementById('cameraPlaceholder');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const toggleBtn = document.getElementById('toggleBtn');

            if (!cameraActive) {
                // Bật camera
                cameraStream.style.display = 'block';
                placeholder.style.display = 'none';
                statusIndicator.classList.add('active');
                statusText.textContent = 'Online';
                toggleBtn.innerHTML = '<i class="fas fa-stop"></i> Tắt Camera';
                cameraActive = true;

                // Kiểm tra xem camera stream có hoạt động không
                cameraStream.onload = function() {
                    console.log('Camera stream loaded successfully');
                };

                cameraStream.onerror = function() {
                    console.error('Failed to load camera stream');
                    // Fallback nếu không kết nối được
                    cameraStream.style.display = 'none';
                    placeholder.style.display = 'block';
                    placeholder.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 10px; color: #e74c3c;"></i>
                        <p>Không thể kết nối camera</p>
                    `;
                    statusIndicator.classList.remove('active');
                    statusText.textContent = 'Lỗi kết nối';
                };
            } else {
                // Tắt camera
                cameraStream.style.display = 'none';
                placeholder.style.display = 'block';
                placeholder.innerHTML = `
                    <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>Camera đã tắt</p>
                `;
                statusIndicator.classList.remove('active');
                statusText.textContent = 'Offline';
                toggleBtn.innerHTML = '<i class="fas fa-play"></i> Bật Camera';
                cameraActive = false;
            }
        }

        function captureImage() {
            if (!cameraActive) {
                alert('Vui lòng bật camera trước khi chụp ảnh!');
                return;
            }

            // Gửi request để chụp ảnh
            fetch('/capture_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Đã chụp ảnh thành công!');
                } else {
                    alert('Lỗi khi chụp ảnh: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error capturing image:', error);
                alert('Có lỗi xảy ra khi chụp ảnh!');
            });
        }



        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                // Luôn gọi API backend để lấy data mới nhất
                const response = await fetch('/api/emotions');
                const data = await response.json();

                console.log("Dữ liệu từ API:", data);  // Kiểm tra dữ liệu nhận được

                studentsData = data.data || [];
                if (studentsData.length === 0) {
                    console.error("Không có dữ liệu học sinh!");
                }

                updateStats();
                renderStudentsTable();

                if (performanceChart) {
                    performanceChart.destroy();
                }
                initializeChart();

                document.getElementById('lastUpdate').textContent = data.last_update 
                    ? new Date(data.last_update).toLocaleString('vi-VN') 
                    : 'Chưa có dữ liệu';
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function refreshData() {
            loadData();
        }

        // Auto refresh every 30 seconds
        setInterval(loadData, 30000);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>